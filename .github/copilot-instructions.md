# Copilot Instructions

- **Project shape**: Monorepo pnpm workspace; backend Payload CMS in [packages/payload-cms](packages/payload-cms), frontend Next.js App Router in [packages/frontend](packages/frontend), migration utilities in [scripts/migration](scripts/migration), legacy static data in [old_website](old_website).
- **Core docs**: Stack and commands in [README.md](README.md); architecture plan in [docs/PIANO_IMPLEMENTAZIONE.md](docs/PIANO_IMPLEMENTAZIONE.md); data model in [docs/Lemmario - Requisiti struttura dati - AGGIORNATO.md](docs/Lemmario%20-%20Requisiti%20struttura%20dati%20-%20AGGIORNATO.md); migration flow in [docs/MIGRATION.md](docs/MIGRATION.md); agent usage notes in [docs/AGENT_E_SKILLS_GUIDE.md](docs/AGENT_E_SKILLS_GUIDE.md).
- **Dev commands (root)**: `pnpm dev` to run all packages; `pnpm dev:payload` and `pnpm dev:frontend` for single services; `pnpm build|typecheck|lint|clean` use `pnpm --filter "./packages/*" ...` under the hood.
- **Payload package**: [packages/payload-cms/package.json](packages/payload-cms/package.json) scripts `dev` (nodemon), `build` (tsc), `start` (node dist), `db:migrate` (payload migrate), `db:seed` (ts-node seed). Requires PostgreSQL connection via env `DATABASE_URI` and `PAYLOAD_SECRET`.
- **Frontend package**: [packages/frontend/package.json](packages/frontend/package.json) uses standard Next 14 scripts `dev/build/start/lint/typecheck`; output in `.next`; depends on `NEXT_PUBLIC_SITE_URL`/API envs.
- **Docker**: Compose files expose payload on 3000, frontend on 3001, postgres on 5432. Start with `docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d` as described in [README.md](README.md#avviare-con-docker-compose-development).
- **Migration prerequisites**: Ensure Payload API reachable (`curl http://localhost:3000/api/lemmari`), then run from [scripts](scripts) workspace with Node 20/pnpm 8.
- **Run migration**: `cd scripts && API_URL=http://localhost:3000/api LEMMARIO_ID=2 pnpm migrate` to import all; debug a single entry with `pnpm test:lemma` as per [docs/MIGRATION.md](docs/MIGRATION.md#esecuzione).
- **Legacy sources**: Parser reads [old_website/bibliografia.json](old_website/bibliografia.json), [old_website/indice.json](old_website/indice.json), and HTML lemmas in [old_website/lemmi](old_website/lemmi); mappings and parser logic documented in [docs/MIGRATION.md](docs/MIGRATION.md#mapping-campi).
- **Import rules**: Keep bibliography `shorthand_id` as `Fonti.shorthand_id` (compatibility + URLs); Latin lemma slugs get `-lat` suffix to avoid collisions; definitions split on `<hr>`; rationality level parsed via regex; occurrences link to bibliography via `data-biblio` attribute.
- **Rate limiting**: Migration intentionally pauses ~100ms per lemma to avoid 429s (see [docs/MIGRATION.md](docs/MIGRATION.md#gestione-errori)); keep delays if adjusting concurrency.
- **Data model essentials**: 13 entities covering multi-tenancy (`Lemmario`, `CampoCustomLemmario`, `UtenteRuoloLemmario`), core lexicon (`Lemma`, `VarianteGrafica`, `Definizione`, `Livello di Razionalit√†`, `Ricorrenza`, `Fonte`, `RiferimentoIncrociato`), CMS/support (`ContenutoStatico`, `Utente`, `StoricoModifiche`). Details in the data spec doc.
- **Rationality levels**: Six fixed codes (1-6) stored in lookup; `Definizione.livello` is nullable but preferred; preserve ordering fields (`ordine`) on definitions/variants for display.
- **Permissions model**: Super admin (global) plus per-lemmario roles via `UtenteRuoloLemmario` (admin/redattore/lettore). Query filtering must respect assigned lemmari; see patterns in [docs/PIANO_IMPLEMENTAZIONE.md](docs/PIANO_IMPLEMENTAZIONE.md#21-entita-lemma-modificata-per-multi-tenancy) and access control notes.
- **Access control during migration**: Collections may be temporarily public (`create: public_`) to allow imports; revert to authenticated access afterward as reminded in [docs/MIGRATION.md](docs/MIGRATION.md#configurazione-access-control-temporanea).
- **Routing expectations**: Frontend routes per lemmario `/[lemmario-slug]`, lemma detail `/[lemmario-slug]/lemmi/[termine]`, bibliography `/[lemmario-slug]/bibliografia`, with SSR/ISR emphasis for SEO ([docs/PIANO_IMPLEMENTAZIONE.md](docs/PIANO_IMPLEMENTAZIONE.md#12-flusso-dati)).
- **Conventions**: Use JSONB `configurazione` for lemmario-specific flags; keep `shorthand_id` unique on `Fonte`; enforce unique (`utente_id`, `lemmario_id`) on junction table; maintain bidirectional references via hooks and audit trail where planned in the implementation plan.
- **Testing/linting**: Prefer root scripts to cover all packages; run package-local `lint`/`typecheck` when iterating. Clean builds with `pnpm clean` (root) or package-level `clean` scripts.
- **Dependencies**: Backend uses `@payloadcms/db-postgres`, `drizzle-orm`, Lexical richtext; frontend is bare Next 14; migration scripts rely on `cheerio` + `ts-node`. Ensure TypeScript strictness and Node 20 compatibility.
