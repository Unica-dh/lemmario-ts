name: Database Reset (DESTRUCTIVE)

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type YES_DELETE_DATABASE to confirm'
        required: true
        type: choice
        options:
          - 'NO'
          - 'YES_DELETE_DATABASE'
      run_seed:
        description: 'Run database seed after reset'
        required: false
        type: boolean
        default: false

jobs:
  reset-database:
    name: Reset PostgreSQL database
    runs-on: [self-hosted, Linux, X64]
    environment: production-destructive
    steps:
      - name: Clone repository (manual git)
        run: |
          cd $HOME
          rm -rf /tmp/lemmario-reset-${{ github.run_id }}
          git clone --depth=1 https://github.com/${{ github.repository }}.git /tmp/lemmario-reset-${{ github.run_id }}

      - name: Copy reset script to server location
        run: |
          cp /tmp/lemmario-reset-${{ github.run_id }}/scripts/deploy/reset-db-lemmario.sh /home/dhomeka/reset-db-lemmario.sh
          chmod +x /home/dhomeka/reset-db-lemmario.sh

      - name: Verify confirmation
        run: |
          if [ "${{ inputs.confirmation }}" != "YES_DELETE_DATABASE" ]; then
            echo "ERROR: Confirmation not provided. Aborting."
            echo "You must select 'YES_DELETE_DATABASE' to proceed."
            exit 1
          fi

      - name: Execute database reset
        run: |
          SEED_FLAG=""
          if [ "${{ inputs.run_seed }}" == "true" ]; then
            SEED_FLAG="--seed"
          fi
          /home/dhomeka/reset-db-lemmario.sh $SEED_FLAG

      - name: Cleanup temporary checkout
        if: always()
        run: |
          rm -rf /tmp/lemmario-reset-${{ github.run_id }}

      - name: Verify services after reset
        run: |
          echo "Verifying services are running..."
          docker ps --filter "name=lemmario"
          echo ""
          echo "Database reset completed successfully!"
