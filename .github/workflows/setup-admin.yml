name: Setup Admin and Lemmario

on:
  workflow_dispatch:
    inputs:
      admin_email:
        description: 'Email admin'
        required: true
        default: 'admin@lemmario.it'
        type: string
      admin_password:
        description: 'Password admin'
        required: true
        type: string
      lemmario_slug:
        description: 'Slug lemmario'
        required: true
        default: 'matematica'
        type: string
      lemmario_titolo:
        description: 'Titolo lemmario'
        required: true
        default: 'Lemmario di Matematica'
        type: string
      force_recreate_user:
        description: 'Forza ricreazione utente (cancella esistente)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  setup:
    name: Create Admin and Lemmario
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Wait for Payload to be ready
        run: |
          echo "Waiting for Payload API to be ready..."
          for i in {1..30}; do
            if curl -s "http://localhost:3000/api/access" > /dev/null 2>&1; then
              echo "Payload is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERROR: Payload not responding"
              exit 1
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Check existing user and try login
        id: check_user
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
          ADMIN_PASSWORD: ${{ inputs.admin_password }}
        run: |
          # Check if user exists in database
          USER_COUNT=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM utenti WHERE email='${ADMIN_EMAIL}';" | tr -d ' ')
          echo "User count for email: $USER_COUNT"

          if [[ "$USER_COUNT" -gt 0 ]]; then
            echo "User exists, trying login..."
            RESPONSE=$(curl -s -X POST "http://localhost:3000/api/utenti/login" \
              -H "Content-Type: application/json" \
              -d "{\"email\": \"${ADMIN_EMAIL}\", \"password\": \"${ADMIN_PASSWORD}\"}")

            TOKEN=$(echo "$RESPONSE" | jq -r '.token // empty')
            if [[ -n "$TOKEN" ]]; then
              echo "Login successful!"
              echo "user_exists=true" >> $GITHUB_OUTPUT
              echo "can_login=true" >> $GITHUB_OUTPUT
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
            else
              echo "User exists but cannot login (bad password hash)"
              echo "user_exists=true" >> $GITHUB_OUTPUT
              echo "can_login=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "User does not exist"
            echo "user_exists=false" >> $GITHUB_OUTPUT
            echo "can_login=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing user if force_recreate or cannot login
        if: (steps.check_user.outputs.user_exists == 'true' && steps.check_user.outputs.can_login == 'false') || inputs.force_recreate_user == 'true'
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
        run: |
          echo "Deleting existing user to recreate with proper password..."
          docker exec lemmario_db psql -U lemmario_user -d lemmario_db -c "DELETE FROM utenti WHERE email='${ADMIN_EMAIL}';"
          echo "User deleted"

      - name: Get database schema info
        id: schema_info
        run: |
          echo "Checking utenti table schema..."
          docker exec lemmario_db psql -U lemmario_user -d lemmario_db -c "\d utenti" || true

      - name: Create admin user via Payload first-register
        id: create_user
        if: steps.check_user.outputs.can_login != 'true'
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
          ADMIN_PASSWORD: ${{ inputs.admin_password }}
        run: |
          echo "Creating admin user..."

          # Try Payload's first-register endpoint (available when no users exist)
          RESPONSE=$(curl -s -X POST "http://localhost:3000/api/utenti/first-register" \
            -H "Content-Type: application/json" \
            -d "{
              \"email\": \"${ADMIN_EMAIL}\",
              \"password\": \"${ADMIN_PASSWORD}\",
              \"nome\": \"Admin\",
              \"cognome\": \"Lemmario\",
              \"ruolo\": \"super_admin\",
              \"attivo\": true
            }")

          echo "First-register response: $RESPONSE"

          USER_ID=$(echo "$RESPONSE" | jq -r '.user.id // .doc.id // empty')
          if [[ -n "$USER_ID" ]]; then
            echo "User created via first-register with ID: $USER_ID"
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "First-register failed, trying normal API with internal credentials..."

            # Try using Payload internal API via admin panel cookie simulation
            # Generate password hash using pbkdf2 (Node.js built-in, similar to bcrypt)
            HASH=$(docker exec lemmario_payload node -e "
              const crypto = require('crypto');
              const password = '${ADMIN_PASSWORD}';
              const salt = crypto.randomBytes(16).toString('hex');
              const hash = crypto.pbkdf2Sync(password, salt, 100000, 64, 'sha512').toString('hex');
              // Output in bcrypt-like format that Payload might accept
              // Actually, let's just compute a simple hash for testing
              const bcryptStyle = '\$2a\$10\$' + crypto.createHash('sha256').update(password + salt).digest('base64').slice(0, 53);
              console.log(bcryptStyle);
            " 2>&1)

            echo "Generated hash: ${HASH:0:20}..."

            # Insert directly with the hash
            docker exec lemmario_db psql -U lemmario_user -d lemmario_db -c "
              INSERT INTO utenti (email, hash, nome, cognome, ruolo, attivo, created_at, updated_at)
              VALUES ('${ADMIN_EMAIL}', '${HASH}', 'Admin', 'Lemmario', 'super_admin', true, NOW(), NOW())
              ON CONFLICT (email) DO UPDATE SET hash = EXCLUDED.hash, updated_at = NOW();
            "

            echo "User inserted via SQL (login may not work)"
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Login after creation
        id: login
        if: steps.check_user.outputs.can_login != 'true'
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
          ADMIN_PASSWORD: ${{ inputs.admin_password }}
        run: |
          echo "Trying login after user creation..."

          RESPONSE=$(curl -s -X POST "http://localhost:3000/api/utenti/login" \
            -H "Content-Type: application/json" \
            -d "{\"email\": \"${ADMIN_EMAIL}\", \"password\": \"${ADMIN_PASSWORD}\"}")

          echo "Login response: $RESPONSE"

          TOKEN=$(echo "$RESPONSE" | jq -r '.token // empty')
          if [[ -n "$TOKEN" ]]; then
            echo "Login successful!"
            echo "token=$TOKEN" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Login failed even after user creation"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Set final token
        id: final_token
        run: |
          if [[ -n "${{ steps.check_user.outputs.token }}" ]]; then
            echo "token=${{ steps.check_user.outputs.token }}" >> $GITHUB_OUTPUT
          elif [[ -n "${{ steps.login.outputs.token }}" ]]; then
            echo "token=${{ steps.login.outputs.token }}" >> $GITHUB_OUTPUT
          else
            echo "::error::No token available"
            exit 1
          fi

      - name: Check if lemmario already exists
        id: check_lemmario
        run: |
          COUNT=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM lemmari WHERE slug='${{ inputs.lemmario_slug }}';" | tr -d ' ')
          echo "Existing lemmari with this slug: $COUNT"
          if [[ "$COUNT" -gt 0 ]]; then
            LEMMARIO_ID=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT id FROM lemmari WHERE slug='${{ inputs.lemmario_slug }}' LIMIT 1;" | tr -d ' ')
            echo "lemmario_exists=true" >> $GITHUB_OUTPUT
            echo "lemmario_id=$LEMMARIO_ID" >> $GITHUB_OUTPUT
          else
            echo "lemmario_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create lemmario
        if: steps.check_lemmario.outputs.lemmario_exists == 'false'
        env:
          LEMMARIO_SLUG: ${{ inputs.lemmario_slug }}
          LEMMARIO_TITOLO: ${{ inputs.lemmario_titolo }}
        run: |
          echo "Creating lemmario..."

          RESPONSE=$(curl -s -X POST "http://localhost:3000/api/lemmari" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ steps.final_token.outputs.token }}" \
            -d "{
              \"slug\": \"${LEMMARIO_SLUG}\",
              \"titolo\": \"${LEMMARIO_TITOLO}\",
              \"descrizione\": \"Dizionario della terminologia matematica ed economica medievale italiana\",
              \"periodo_storico\": \"XIV-XV secolo\",
              \"attivo\": true,
              \"ordine\": 1
            }")

          echo "Response: $RESPONSE"

          LEMMARIO_ID=$(echo "$RESPONSE" | jq -r '.doc.id // empty')
          if [[ -z "$LEMMARIO_ID" ]]; then
            echo "::error::Failed to create lemmario"
            exit 1
          fi

          echo "Lemmario created with ID: $LEMMARIO_ID"

      - name: Display summary
        run: |
          echo "==========================================="
          echo "Setup completed!"
          echo "==========================================="

          # Get counts from database directly
          UTENTI=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM utenti;" | tr -d ' ')
          LEMMARI=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM lemmari;" | tr -d ' ')

          echo "Users: $UTENTI"
          echo "Lemmari: $LEMMARI"

          # Get lemmario ID for migration
          LEMMARIO_ID=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT id FROM lemmari WHERE slug='${{ inputs.lemmario_slug }}' LIMIT 1;" | tr -d ' ')
          echo ""
          echo "Lemmario ID for migration: $LEMMARIO_ID"
          echo ""
          echo "Next step: Run Data Migration workflow with lemmario_id=$LEMMARIO_ID"
