name: Setup Admin and Lemmario

on:
  workflow_dispatch:
    inputs:
      admin_email:
        description: 'Email admin'
        required: true
        default: 'admin@lemmario.it'
        type: string
      admin_password:
        description: 'Password admin'
        required: true
        type: string
      lemmario_slug:
        description: 'Slug lemmario'
        required: true
        default: 'matematica'
        type: string
      lemmario_titolo:
        description: 'Titolo lemmario'
        required: true
        default: 'Lemmario di Matematica'
        type: string

jobs:
  setup:
    name: Create Admin and Lemmario
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Wait for Payload to be ready
        run: |
          echo "Waiting for Payload API to be ready..."
          for i in {1..30}; do
            if curl -s "http://localhost:3000/api/access" > /dev/null 2>&1; then
              echo "Payload is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERROR: Payload not responding"
              exit 1
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Check existing users count
        id: check_users
        run: |
          # Check users directly in database
          COUNT=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM utenti;" | tr -d ' ')
          echo "Existing users in database: $COUNT"
          echo "user_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Create admin user via Payload script
        if: steps.check_users.outputs.user_count == '0'
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
          ADMIN_PASSWORD: ${{ inputs.admin_password }}
        run: |
          echo "Creating admin user directly in payload container..."

          # Execute a Node.js script inside the payload container to create the user
          docker exec lemmario_payload node -e "
          const payload = require('payload');
          const config = require('./dist/payload.config').default;

          async function createAdmin() {
            await payload.init({
              secret: process.env.PAYLOAD_SECRET,
              config,
              local: true,
            });

            const user = await payload.create({
              collection: 'utenti',
              data: {
                email: '${ADMIN_EMAIL}',
                password: '${ADMIN_PASSWORD}',
                nome: 'Admin',
                cognome: 'Lemmario',
                ruolo: 'super_admin',
                attivo: true,
              },
              overrideAccess: true,
            });

            console.log('User created:', user.id);
            process.exit(0);
          }

          createAdmin().catch(err => {
            console.error('Error:', err.message);
            process.exit(1);
          });
          " 2>&1 || {
            echo "Node script failed, trying direct SQL..."

            # Fallback: Create user directly in database with bcrypt hash
            # Note: This is a workaround and may not work perfectly with Payload's auth
            docker exec lemmario_db psql -U lemmario_user -d lemmario_db -c "
              INSERT INTO utenti (email, nome, cognome, ruolo, attivo, created_at, updated_at)
              VALUES ('${ADMIN_EMAIL}', 'Admin', 'Lemmario', 'super_admin', true, NOW(), NOW())
              ON CONFLICT (email) DO NOTHING;
            "
            echo "User inserted via SQL (password needs to be set via admin panel)"
          }

      - name: Verify admin exists and login
        id: login
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
          ADMIN_PASSWORD: ${{ inputs.admin_password }}
        run: |
          echo "Checking if admin was created..."

          # Try to login
          RESPONSE=$(curl -s -X POST "http://localhost:3000/api/utenti/login" \
            -H "Content-Type: application/json" \
            -d "{
              \"email\": \"${ADMIN_EMAIL}\",
              \"password\": \"${ADMIN_PASSWORD}\"
            }")

          echo "Login response: $RESPONSE"

          TOKEN=$(echo "$RESPONSE" | jq -r '.token // empty')
          if [[ -z "$TOKEN" ]]; then
            echo "::warning::Could not login with credentials. User may need password reset."
            # Get user ID for next steps
            USER_ID=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT id FROM utenti WHERE email='${ADMIN_EMAIL}' LIMIT 1;" | tr -d ' ')
            if [[ -n "$USER_ID" ]]; then
              echo "User exists with ID: $USER_ID"
              echo "has_token=false" >> $GITHUB_OUTPUT
            else
              echo "::error::User was not created"
              exit 1
            fi
          else
            echo "Login successful!"
            echo "token=$TOKEN" >> $GITHUB_OUTPUT
            echo "has_token=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if lemmario already exists
        id: check_lemmario
        run: |
          COUNT=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM lemmari WHERE slug='${{ inputs.lemmario_slug }}';" | tr -d ' ')
          echo "Existing lemmari with this slug: $COUNT"
          if [[ "$COUNT" -gt 0 ]]; then
            LEMMARIO_ID=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT id FROM lemmari WHERE slug='${{ inputs.lemmario_slug }}' LIMIT 1;" | tr -d ' ')
            echo "lemmario_exists=true" >> $GITHUB_OUTPUT
            echo "lemmario_id=$LEMMARIO_ID" >> $GITHUB_OUTPUT
          else
            echo "lemmario_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create lemmario via API or SQL
        if: steps.check_lemmario.outputs.lemmario_exists == 'false'
        env:
          LEMMARIO_SLUG: ${{ inputs.lemmario_slug }}
          LEMMARIO_TITOLO: ${{ inputs.lemmario_titolo }}
        run: |
          echo "Creating lemmario..."

          if [[ "${{ steps.login.outputs.has_token }}" == "true" ]]; then
            # Use API with token
            RESPONSE=$(curl -s -X POST "http://localhost:3000/api/lemmari" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ steps.login.outputs.token }}" \
              -d "{
                \"slug\": \"${LEMMARIO_SLUG}\",
                \"titolo\": \"${LEMMARIO_TITOLO}\",
                \"descrizione\": \"Dizionario della terminologia matematica ed economica medievale italiana\",
                \"periodo_storico\": \"XIV-XV secolo\",
                \"attivo\": true,
                \"ordine\": 1
              }")

            echo "Response: $RESPONSE"
            LEMMARIO_ID=$(echo "$RESPONSE" | jq -r '.doc.id // empty')
          else
            # Fallback to direct SQL
            docker exec lemmario_db psql -U lemmario_user -d lemmario_db -c "
              INSERT INTO lemmari (slug, titolo, descrizione, periodo_storico, attivo, ordine, created_at, updated_at)
              VALUES ('${LEMMARIO_SLUG}', '${LEMMARIO_TITOLO}', 'Dizionario della terminologia matematica ed economica medievale italiana', 'XIV-XV secolo', true, 1, NOW(), NOW())
              ON CONFLICT (slug) DO NOTHING;
            "
            LEMMARIO_ID=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT id FROM lemmari WHERE slug='${LEMMARIO_SLUG}' LIMIT 1;" | tr -d ' ')
          fi

          if [[ -z "$LEMMARIO_ID" ]]; then
            echo "::error::Failed to create lemmario"
            exit 1
          fi

          echo "Lemmario created with ID: $LEMMARIO_ID"

      - name: Display summary
        run: |
          echo "==========================================="
          echo "Setup completed!"
          echo "==========================================="

          # Get counts from database directly
          UTENTI=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM utenti;" | tr -d ' ')
          LEMMARI=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT COUNT(*) FROM lemmari;" | tr -d ' ')

          echo "Users: $UTENTI"
          echo "Lemmari: $LEMMARI"

          # Get lemmario ID for migration
          LEMMARIO_ID=$(docker exec lemmario_db psql -U lemmario_user -d lemmario_db -t -c "SELECT id FROM lemmari WHERE slug='${{ inputs.lemmario_slug }}' LIMIT 1;" | tr -d ' ')
          echo ""
          echo "Lemmario ID for migration: $LEMMARIO_ID"
          echo ""
          echo "Next step: Run Data Migration workflow with lemmario_id=$LEMMARIO_ID"
